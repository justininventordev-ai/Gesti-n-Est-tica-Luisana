<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | Estética Luisana</title>
    
    <!-- Librería de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #db2777;
            --primary-dark: #be185d;
            --primary-soft: #fdf2f8;
            --accent: #eab308;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --radius-xl: 20px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #0f172a;
                --bg-card: #1e293b;
                --text-main: #f8fafc;
                --text-muted: #94a3b8;
                --border-color: #334155;
                --primary-soft: #31212d;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main);
            line-height: 1.5;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* --- Header --- */
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .back-btn:hover { color: var(--primary); }

        /* --- Layout --- */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .grid-layout { grid-template-columns: 1fr; }
            .preview-pane { display: none; }
        }

        /* --- Cards & Panels --- */
        .panel {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .panel-subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 2rem;
        }

        .section-header {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin: 1.5rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-header::after { content: ""; flex: 1; height: 1px; background: var(--border-color); }

        /* --- Inputs --- */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }

        .form-group { margin-bottom: 1.25rem; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main); }

        input, select {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: var(--radius-lg);
            border: 2px solid var(--border-color);
            background: transparent;
            color: var(--text-main);
            font-size: 0.95rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft);
        }

        select option {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 10px;
        }

        /* --- Media Manager --- */
        .media-manager {
            background: var(--bg-body);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px dashed var(--border-color);
        }

        .method-toggle {
            display: inline-flex;
            background: var(--border-color);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .toggle-btn {
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        .toggle-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); }

        .main-upload { margin-bottom: 1.5rem; }
        .upload-box {
            position: relative;
            height: 120px;
            border: 2px dashed var(--primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            transition: 0.2s;
            background: var(--bg-card);
        }
        .upload-box:hover { background: var(--primary-soft); }
        .upload-box input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .upload-box span { font-size: 0.75rem; font-weight: 600; color: var(--primary); }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
        }
        .gallery-item {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        .gallery-item label { font-size: 0.6rem; text-align: center; color: var(--text-muted); }
        .gallery-item .mini-upload {
            height: 60px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .gallery-item .mini-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .gallery-item .mini-upload i { font-size: 0.8rem; color: var(--text-muted); }

        /* --- Buttons --- */
        .btn-primary {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: var(--radius-lg);
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 12px rgba(219, 39, 119, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(219, 39, 119, 0.4); }
        .btn-primary:disabled { opacity: 0.7; transform: none; cursor: wait; }

        .btn-cancel {
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-weight: 500;
        }

        /* --- Preview Pane --- */
        .preview-pane { position: sticky; top: 2rem; }
        .preview-card {
            background: var(--bg-card);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
        .preview-img { width: 100%; height: 220px; object-fit: cover; background: #f1f5f9; }
        .preview-content { padding: 1.5rem; text-align: center; }
        .preview-category { font-size: 0.65rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
        .preview-name { font-family: 'Playfair Display', serif; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .preview-price { font-size: 1.25rem; font-weight: 700; color: var(--text-main); }

        /* --- Inventory --- */
        .inventory-section { margin-top: 3rem; }
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .inventory-header h2 { font-family: 'Playfair Display', serif; font-size: 1.8rem; }
        
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .item-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            transition: 0.3s;
        }
        .item-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .item-card img { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; }
        .item-card-info { flex: 1; }
        .item-card-info h4 { font-size: 0.95rem; margin-bottom: 0.25rem; }
        .item-card-info p { color: var(--primary); font-weight: 700; font-size: 0.9rem; }
        
        .item-actions { display: flex; flex-direction: column; gap: 0.5rem; }
        .btn-icon {
            padding: 0.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 700;
            transition: 0.2s;
        }
        .edit-icon { background: #eff6ff; color: #2563eb; }
        .edit-icon:hover { background: #2563eb; color: white; }
        .delete-icon { background: #fef2f2; color: #dc2626; }
        .delete-icon:hover { background: #dc2626; color: white; }

        /* --- Messages --- */
        .alert { padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem; display: none; font-size: 0.85rem; font-weight: 500; }
        .alert-success { display: block; background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .alert-error { display: block; background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    </style>
</head>
<body>

    <div class="container">
        <header class="header-actions">
            <a href="index.html" class="back-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Volver a la tienda
            </a>
            <div id="status-tag" style="font-size: 0.7rem; font-weight: 700; color: var(--accent);">● SISTEMA ACTIVO</div>
        </header>

        <main class="grid-layout">
            <!-- Formulario -->
            <section>
                <form id="admin-form" class="panel">
                    <div class="brand-header">
                        <h1 class="panel-title" id="form-title">Gestionar Tratamiento</h1>
                        <p class="panel-subtitle" id="form-desc">Define los detalles del servicio y su galería visual.</p>
                    </div>

                    <div id="msg-box" class="alert"></div>
                    <input type="hidden" id="edit-id">

                    <!-- Info General -->
                    <div class="section-header">Información del Servicio</div>
                    <div class="form-group">
                        <label>Nombre del Tratamiento</label>
                        <input type="text" id="nombre" placeholder="Ej: Facial Hidratante de Oro" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Precio (COP)</label>
                            <input type="number" id="precio" placeholder="150000" required>
                        </div>
                        <div class="form-group">
                            <label>Descuento (%)</label>
                            <input type="number" id="descuento" value="0" min="0" max="100">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Categoría del Tratamiento</label>
                        <select id="categoria">
                            <option value="pestañas">Cejas y Pestañas</option>
                            <option value="cosmetologia">Cosmetología General</option>
                            <option value="limpieza">Limpieza Facial</option>
                            <option value="adelgazar">Adelgazamiento</option>
                            <option value="laser">Tecnología Láser</option>
                            <option value="masajes">Masajes y Relajación</option>
                        </select>
                    </div>

                    <!-- Media -->
                    <div class="section-header">Contenido Multimedia</div>
                    <div class="media-manager">
                        <div class="method-toggle">
                            <button type="button" class="toggle-btn active" id="btn-file-method">ARCHIVOS</button>
                            <button type="button" class="toggle-btn" id="btn-url-method">ENLACES URL</button>
                        </div>

                        <!-- Carga Principal -->
                        <div class="main-upload">
                            <label>Imagen de Portada (Obligatoria)</label>
                            <div id="container-file" class="upload-box">
                                <span id="file-status">CLICK O ARRASTRA LA PORTADA</span>
                                <input type="file" id="imagen-file" accept="image/*">
                            </div>
                            <div id="container-url" style="display: none;">
                                <input type="text" id="imagen-url" placeholder="https://ejemplo.com/portada.jpg">
                            </div>
                        </div>

                        <!-- Galería Secundaria -->
                        <label>Galería Adicional (Opcional - Máx 5)</label>
                        <div class="gallery-grid" id="gallery-files">
                            <div class="gallery-item"><div class="mini-upload"><input type="file" id="imagen1-file" accept="image/*"><i>+</i></div><label>Img 1</label></div>
                            <div class="gallery-item"><div class="mini-upload"><input type="file" id="imagen2-file" accept="image/*"><i>+</i></div><label>Img 2</label></div>
                            <div class="gallery-item"><div class="mini-upload"><input type="file" id="imagen3-file" accept="image/*"><i>+</i></div><label>Img 3</label></div>
                            <div class="gallery-item"><div class="mini-upload"><input type="file" id="imagen4-file" accept="image/*"><i>+</i></div><label>Img 4</label></div>
                            <div class="gallery-item"><div class="mini-upload"><input type="file" id="imagen5-file" accept="image/*"><i>+</i></div><label>Img 5</label></div>
                        </div>
                        <div class="gallery-grid" id="gallery-urls" style="display: none;">
                            <input type="text" id="imagen1-url" placeholder="URL 1" style="font-size: 0.7rem; padding: 0.5rem;">
                            <input type="text" id="imagen2-url" placeholder="URL 2" style="font-size: 0.7rem; padding: 0.5rem;">
                            <input type="text" id="imagen3-url" placeholder="URL 3" style="font-size: 0.7rem; padding: 0.5rem;">
                            <input type="text" id="imagen4-url" placeholder="URL 4" style="font-size: 0.7rem; padding: 0.5rem;">
                            <input type="text" id="imagen5-url" placeholder="URL 5" style="font-size: 0.7rem; padding: 0.5rem;">
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <button type="submit" class="btn-primary" id="btn-save">Publicar Tratamiento</button>
                        <button type="button" class="btn-cancel" id="btn-cancel-edit" style="display: none;">Cancelar edición</button>
                    </div>
                </form>
            </section>

            <!-- Vista Previa -->
            <aside class="preview-pane">
                <div class="preview-card">
                    <img src="https://via.placeholder.com/400x300?text=Estética+Luisana" id="ui-img" class="preview-img">
                    <div class="preview-content">
                        <div class="preview-category" id="ui-category">CEJAS Y PESTAÑAS</div>
                        <h3 class="preview-name" id="ui-name">Nombre del Servicio</h3>
                        <div class="preview-price" id="ui-price">$0</div>
                    </div>
                </div>
                <div style="padding: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.75rem;">
                    Los cambios se sincronizan en tiempo real con la base de datos de la tienda.
                </div>
            </aside>
        </main>

        <!-- Lista -->
        <section class="inventory-section">
            <div class="inventory-header">
                <h2>Inventario de Servicios</h2>
                <span id="counter" style="background: var(--primary-soft); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">0 servicios</span>
            </div>
            <div id="product-list" class="product-list">
                <!-- Items dinámicos -->
            </div>
        </section>
    </div>

    <script>
        const SUPABASE_URL = 'https://xyudwrtygzzticgwgamk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5dWR3cnR5Z3p6dGljZ3dnYW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjEwMDUsImV4cCI6MjA4MzAzNzAwNX0.R7186rMbp3jyhjKnLKvNs4LBUxkmBoBeZgcihgsK51g';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isEditing = false;
        let imageMethod = 'file';

        // Gestión de pestañas de método de imagen
        document.getElementById('btn-file-method').onclick = () => setMethod('file');
        document.getElementById('btn-url-method').onclick = () => setMethod('url');

        function setMethod(m) {
            imageMethod = m;
            document.getElementById('btn-file-method').classList.toggle('active', m === 'file');
            document.getElementById('btn-url-method').classList.toggle('active', m === 'url');
            
            document.getElementById('container-file').style.display = m === 'file' ? 'flex' : 'none';
            document.getElementById('gallery-files').style.display = m === 'file' ? 'grid' : 'none';
            
            document.getElementById('container-url').style.display = m === 'url' ? 'block' : 'none';
            document.getElementById('gallery-urls').style.display = m === 'url' ? 'grid' : 'none';
        }

        // Limpiar formulario
        function clearAll() {
            isEditing = false;
            document.getElementById('admin-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('form-title').innerText = "Gestionar Tratamiento";
            document.getElementById('btn-save').innerText = "Publicar Tratamiento";
            document.getElementById('btn-cancel-edit').style.display = 'none';
            document.getElementById('file-status').innerText = "CLICK O ARRASTRA LA PORTADA";
            document.getElementById('ui-img').src = "https://via.placeholder.com/400x300?text=Estética+Luisana";
            document.getElementById('ui-name').innerText = "Nombre del Servicio";
            document.getElementById('ui-price').innerText = "$0";
            document.getElementById('ui-category').innerText = "CEJAS Y PESTAÑAS";
            setMethod('file');
        }

        // Live Preview
        document.getElementById('imagen-file').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('file-status').innerText = "✓ " + file.name.substring(0, 15) + "...";
                const reader = new FileReader();
                reader.onload = (ev) => document.getElementById('ui-img').src = ev.target.result;
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('imagen-url').oninput = (e) => {
            if (e.target.value.startsWith('http')) document.getElementById('ui-img').src = e.target.value;
        };

        // Mejora en la actualización de la categoría en la vista previa
        document.getElementById('admin-form').oninput = () => {
            document.getElementById('ui-name').innerText = document.getElementById('nombre').value || 'Nombre del Servicio';
            const price = document.getElementById('precio').value || 0;
            document.getElementById('ui-price').innerText = "$" + parseInt(price).toLocaleString();
            
            // Mostrar el texto elegante de la categoría, no el value interno
            const catSelect = document.getElementById('categoria');
            document.getElementById('ui-category').innerText = catSelect.options[catSelect.selectedIndex].text.toUpperCase();
        };

        // Cargar Lista
        async function loadServices() {
            const listDiv = document.getElementById('product-list');
            const { data, error } = await supabaseClient.from('servicios').select('*').order('created_at', { ascending: false });
            
            if (error) {
                listDiv.innerHTML = `<p style="color:red">Error de conexión</p>`;
                return;
            }
            
            document.getElementById('counter').innerText = `${data.length} servicios`;
            listDiv.innerHTML = data.length ? '' : '<p style="color:var(--text-muted)">No hay servicios registrados.</p>';
            
            data.forEach(s => {
                const item = document.createElement('div');
                item.className = 'item-card';
                item.innerHTML = `
                    <img src="${s.imagen}" onerror="this.src='https://via.placeholder.com/100?text=Luisana'">
                    <div class="item-card-info">
                        <h4>${s.nombre}</h4>
                        <p>$${s.precio.toLocaleString()}</p>
                        <small style="font-size:0.65rem; color:var(--text-muted)">${s.categoria.toUpperCase()}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon edit-icon" onclick="prepareEdit('${s.id}')">EDITAR</button>
                        <button class="btn-icon delete-icon" onclick="deleteService('${s.id}')">BORRAR</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }

        async function prepareEdit(id) {
            isEditing = true;
            const { data, error } = await supabaseClient.from('servicios').select('*').eq('id', id).single();
            if (error) return;

            document.getElementById('edit-id').value = data.id;
            document.getElementById('nombre').value = data.nombre;
            document.getElementById('precio').value = data.precio;
            document.getElementById('descuento').value = data.descuento;
            document.getElementById('categoria').value = data.categoria;
            
            setMethod('url');
            document.getElementById('imagen-url').value = data.imagen;
            document.getElementById('imagen1-url').value = data.imagen1 || '';
            document.getElementById('imagen2-url').value = data.imagen2 || '';
            document.getElementById('imagen3-url').value = data.imagen3 || '';
            document.getElementById('imagen4-url').value = data.imagen4 || '';
            document.getElementById('imagen5-url').value = data.imagen5 || '';
            
            document.getElementById('btn-save').innerText = "Guardar Cambios";
            document.getElementById('btn-cancel-edit').style.display = 'block';
            document.getElementById('ui-img').src = data.imagen;
            
            // Forzar actualización de vista previa de categoría al editar
            const catSelect = document.getElementById('categoria');
            document.getElementById('ui-category').innerText = catSelect.options[catSelect.selectedIndex].text.toUpperCase();
            document.getElementById('ui-name').innerText = data.nombre;
            document.getElementById('ui-price').innerText = "$" + data.precio.toLocaleString();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteService(id) {
            if (!confirm('¿Estás seguro de eliminar este servicio?')) return;
            const { error } = await supabaseClient.from('servicios').delete().eq('id', id);
            if (!error) loadServices();
        }

        document.getElementById('btn-cancel-edit').onclick = clearAll;

        // Proceso de Guardado
        document.getElementById('admin-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const msg = document.getElementById('msg-box');
            
            btn.disabled = true;
            msg.style.display = 'none';

            try {
                const imgFields = ['imagen', 'imagen1', 'imagen2', 'imagen3', 'imagen4', 'imagen5'];
                const urls = {};

                for (const field of imgFields) {
                    let finalUrl = '';
                    if (imageMethod === 'file') {
                        const inputId = field === 'imagen' ? 'imagen-file' : `${field}-file`;
                        const file = document.getElementById(inputId).files[0];
                        if (file) {
                            const ext = file.name.split('.').pop();
                            const fileName = `serv-${Date.now()}-${field}.${ext}`;
                            const { error: upErr } = await supabaseClient.storage.from('imagenes').upload(fileName, file);
                            if (upErr) throw upErr;
                            const { data } = supabaseClient.storage.from('imagenes').getPublicUrl(fileName);
                            finalUrl = data.publicUrl;
                        }
                    } else {
                        const inputId = field === 'imagen' ? 'imagen-url' : `${field}-url`;
                        finalUrl = document.getElementById(inputId).value;
                    }
                    urls[field] = finalUrl;
                }

                if (!urls.imagen && !isEditing) throw new Error("La imagen de portada es obligatoria");

                const payload = {
                    nombre: document.getElementById('nombre').value,
                    precio: parseFloat(document.getElementById('precio').value),
                    descuento: parseInt(document.getElementById('descuento').value) || 0,
                    categoria: document.getElementById('categoria').value,
                    ...urls
                };

                if (isEditing && !urls.imagen) delete payload.imagen;

                const query = isEditing 
                    ? supabaseClient.from('servicios').update(payload).eq('id', document.getElementById('edit-id').value)
                    : supabaseClient.from('servicios').insert([payload]);

                const { error: dbErr } = await query;
                if (dbErr) throw dbErr;

                msg.innerText = isEditing ? "✓ Cambios guardados correctamente" : "✓ Tratamiento publicado con éxito";
                msg.className = "alert alert-success";
                clearAll();
                loadServices();

            } catch (err) {
                msg.innerHTML = `⚠️ Error: ${err.message}`;
                msg.className = "alert alert-error";
            } finally {
                btn.disabled = false;
            }
        };

        window.onload = loadServices;
    </script>
</body>
</html>
